# 第6讲 | 交换机与VLAN：办公室太复杂，我要回学校

一个交换机肯定不够用，需要多台交换机。

交换机之间连接起来，就形成一个稍微复杂的拓扑结构。

两台交换机连接着三个局域网，每个局域网上都有多台机器。如果机器 1 只知道机器 4 的 IP 地址，当它想要访问机器 4，把包发出去的时候，它必须要知道机器 4 的 MAC 地址。

机器 4 主动响应说，这是找我的，这是我的 MAC 地址。于是一个 ARP 请求就成功完成了。

---

## 如何解决常见的环路问题？

当两个交换机将两个局域网同时连接起来的时候。你可能会觉得，这样反而有了高可用性。但是却不幸地出现了环路。出现了环路会有什么结果呢？

---

## STP 协议

最小生成树

生成树的算法叫作 STP，全称 Spanning Tree Protocol。

STP 协议比较复杂，是一场血雨腥风的武林比武或者华山论剑，最终决出五岳盟主的方式。

- Root Bridge，也就是根交换机。掌门
- Designated Bridges，有的翻译为指定交换机。小弟
- Bridge Protocol Data Units （BPDU） ，网桥协议数据单元。协议
- Priority Vector，优先级向量。实力

---

## STP 的工作过程是怎样的？

所有的交换机都认为自己是掌门，每个网桥都被分配了一个 ID。这个 ID 里有管理员分配的优先级。

既然都是掌门，互相都连着网线，就互相发送 BPDU 来比功夫呗。

四种情形：

- 情形一：掌门遇到掌门
- 情形二：同门相遇
- 情形三：掌门与其他帮派小弟相遇
- 情形四：不同门小弟相遇

---

## 如何解决广播问题和安全问题？

有两种分的方法，

- 一个是物理隔离。

- 另外一种方式是虚拟隔离，就是用我们常说的 VLAN，或者叫虚拟局域网。

使用 VLAN，一个交换机上会连属于多个局域网的机器。

---

交换机怎么区分哪个机器属于哪个局域网呢？

我们只需要在原来的二层的头上加一个 TAG，里面有一个 VLAN ID，一共 12 位。为什么是 12 位呢？因为 12 位可以划分 4096 个 VLAN。

只有相同 VLAN 的包，才会互相转发，不同 VLAN 的包，是看不到的。

我们可以设置交换机每个口所属的 VLAN。如果某个口坐的是程序员，他们属于 VLAN 10；如果某个口坐的是人事，他们属于 VLAN 20；

> 交换机之间怎么连接呢？将两个交换机连接起来的口应该设置成什么 VLAN 呢？对于支持 VLAN 的交换机，有一种口叫作 Trunk 口。它可以转发属于任何 VLAN 的口。交换机之间可以通过这种口相互连接。

学校或者办公室，经常会访问一些网站，这些网站似乎永远不会“挂掉”。那是因为这些网站都生活在一个叫做数据中心的地方。

---

**小结**

- 当交换机的数目越来越多的时候，会遭遇环路问题，让网络包迷路，这就需要使用 STP 协议，通过华山论剑比武的方式，将有环路的图变成没有环路的树，从而解决环路问题。
- 交换机数目多会面临隔离问题，可以通过 VLAN 形成虚拟局域网，从而解决广播问题和安全问题。