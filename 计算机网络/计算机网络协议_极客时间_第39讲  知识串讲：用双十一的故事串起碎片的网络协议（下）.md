# 第39讲 | 知识串讲：用双十一的故事串起碎片的网络协议（下）

封装了一个长长的网络包，“大炮”准备完毕，开始发送。

发送的时候可以说是重重关隘——

从手机到移动网络、互联网，还要经过多个运营商才能到达数据中心，

到了数据中心就进入第二个复杂的过程——

从网关到 VXLAN 隧道，到负载均衡，到 Controller 层、组合服务层、基础服务层，最终才下单入库。

---

### 7. 一座座城池一道道关，流控拥塞与重传

**网络包已经组合完毕**，接下来我们来看，如何经过一道道城关，**到达目标公网 IP**。



对于**手机**来讲，**默认的网关**在 PGW 上。在移动网络里面，从手机到 SGW，到 PGW 是有一条隧道的。

在这条隧道里面，会将上面的**这个包作为隧道的乘客协议**放在里面，外面 SGW 和 PGW 在核心网机房的 IP 地址。网络包直到 PGW（PGW 是隧道的另一端）才将里面的包解出来，转发到外部网络。

所以，从手机发送出来的时候，网络包的结构为——

![image-20200622012755611](C:\Users\HLHDS\AppData\Roaming\Typora\typora-user-images\image-20200622012755611.png)

进入隧道之后，要封装外层的网络地址，因而网络包的格式为：

![image-20200622012817102](C:\Users\HLHDS\AppData\Roaming\Typora\typora-user-images\image-20200622012817102.png)

当隧道在 SGW 的时候，切换了一个隧道，会从 SGW 到 PGW 的隧道，因而网络包的格式为：

![image-20200622012832391](C:\Users\HLHDS\AppData\Roaming\Typora\typora-user-images\image-20200622012832391.png)

在 PGW 的隧道端点将包解出来，转发出去的时候，一般在 PGW 出外部网络的路由器上，会**部署 NAT 服务**，将**手机的 IP 地址转换为公网 IP 地址**，当请求返回的时候，**再 NAT 回来**。

因而在 PGW 之后，相当于做了一次**欧洲十国游型**的**转发**，网络包的格式为：

![image-20200622012919016](C:\Users\HLHDS\AppData\Roaming\Typora\typora-user-images\image-20200622012919016.png)

在 NAT 网关，相当于做了一次**玄奘西游型的转发**，网络包的格式变成：

![image-20200622012934840](C:\Users\HLHDS\AppData\Roaming\Typora\typora-user-images\image-20200622012934840.png)

![img](https://static001.geekbang.org/resource/image/8e/5a/8edfb048b27aed3cc2eeb892ae22175a.jpg)

出了 NAT 网关，就**从核心网到达了互联网**。

---

在网络世界，每一个运营商的网络成为自治系统 AS。每个自治系统都有边界路由器，通过它和外面的世界建立联系。

对于云平台来讲，它可以被称为 Multihomed AS，有多个连接连到其他的 AS，但是大多拒绝帮其他的 AS 传输包。

> 例如一些大公司的网络。对于运营商来说，它可以被称为 Transit AS，有多个连接连到其他的 AS，并且可以帮助其他的 AS 传输包，比如主干网。

---

如何从出口的运营商到达云平台的边界路由器？在路由器之间需要通过 **BGP 协议实现**，BGP 又分为两类，eBGP 和 iBGP。自治系统之间、边界路由器之间使用 eBGP 广播路由。内部网络也需要访问其他的自治系统。

边界路由器如何将 BGP 学习到的路由导入到内部网络呢？通过运行 iBGP，使内部的路由器能够找到到达外网目的地最好的边界路由器。

---

你会发现，这一路，**都是只换 MAC，不换目标 IP 地址**。这就是所谓下一跳的概念。

网络包走在这个复杂的道路上，很可能一不小心就丢了，怎么办？这就需要借助 TCP 的机制重新发送。既然 TCP 要对包进行重传，就需要维护 Sequence Number，看哪些包到了，哪些没到，哪些需要重传，传输的速度应该控制到多少，这就是 **TCP 的滑动窗口协议。**

---

![img](https://static001.geekbang.org/resource/image/ab/52/ab5b03ebf7facf71721566165f921252.jpg)