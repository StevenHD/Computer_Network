# 第5讲 | 从物理层到MAC层：如何在宿舍里自己组网玩联机游戏？

一旦机器有了 IP，就可以在网络的环境里和其他的机器展开沟通了。

两台电脑能不能连接起来呢？当然能啊，买个路由器不就行了。

---

### 第一层（物理层）

使用路由器，是在第三层上。（第三层是网络层，也叫网际层IP）

要想两台电脑能够通信，**两台电脑的 IP 地址、子网掩码和默认网关这三项**必须配置成为一个网络，可以一个是 192.168.0.1/24，另一个是 192.168.0.2/24，否则是不通的。

两台电脑之间的网络包，包含 MAC 层吗？当然包含，要完整。IP 层要封装了 MAC 层才能将包放入物理层。

到此为止，两台电脑已经构成了一个最小的局域网，也即 LAN。可以玩联机局域网游戏啦！

怎么把三台电脑连在一起呢？

有一个叫做 Hub 的东西，也就是集线器。

集线器没有大脑，它完全在物理层工作。它会将自己收到的每一个字节，都复制到其他端口上去。**这是第一层物理层联通的方案**。

---

### 3个问题

- 每一台电脑发出的包是发给谁的？谁应该接收？

- 大家都在发，会不会产生混乱？有没有谁先发、谁后发的规则？

- 如果发送的时候出现了错误，怎么办？

---

### 第二层（数据链路层）

Hub 采取的是广播的模式

第二层，数据链路层，也即 MAC 层要解决的问题。

MAC 的全称是 Medium Access Control，即媒体访问控制。控制什么呢？其实就是控制在往媒体上发数据的时候，谁先发、谁后发的问题。防止发生混乱。这解决的是第二个问题。这个问题中的规则，学名叫多路访问。

- 方式一：分多个车道。每个车一个车道，你走你的，我走我的。这在计算机网络里叫作**信道划分**；
- 方式二：今天单号出行，明天双号出行，轮着来。这在计算机网络里叫作**轮流协议**；
- 方式三：不管三七二十一，有事儿先出门，发现特堵，就回去。错过高峰再出。我们叫作**随机接入协议**。著名的以太网，用的就是这个方式。

MAC 的问题也就解决好了。这和 MAC 地址没什么关系。

---

**发给谁，谁接收？**

这里用到一个物理地址，叫作**链路层地址**。但是因为第二层主要解决媒体接入控制的问题，所以它常被称为MAC 地址。

目标的 MAC 地址和源的 MAC 地址。

类型，大部分的类型是 IP 数据包，然后 IP 里面包含 TCP、UDP，以及 HTTP 等，这都是里层封装的事情。

> 有了这个目标 MAC 地址，数据包在链路上广播，MAC 的网卡才能发现，这个包是给它的。MAC 的网卡把包收进来，然后打开 IP 包，发现 IP 地址也是自己的，再打开 TCP 包，发现端口是自己，也就是 80，而 nginx 就是监听 80。

对于以太网，第二层的最后面是 **CRC**，也就是**循环冗余检测**。通过 XOR 异或的算法，来计算整个包是否在发送的过程中出现了错误，主要解决第三个问题。

---

一个广播的网络里面接入了 N 台机器，我怎么知道每个 MAC 地址是谁呢？这就是**ARP 协议**，也就是已知 IP 地址，求 MAC 地址的协议。

在一个局域网里面，当知道了 IP 地址，不知道 MAC 怎么办呢？靠“吼”。

广而告之，发送一个广播包，谁是这个 IP 谁来回答。

为了避免每次都用 ARP 请求，机器本地也会进行 ARP 缓存。ARP 的 MAC 地址缓存过一段时间就会过期。

----

这个设备显然是个二层设备，我们称为交换机。

交换机怎么知道每个口的电脑的 MAC 地址呢？这需要交换机会学习。

当然，每个机器的 IP 地址会变，所在的口也会变，因而交换机上的学习的结果，我们称为**转发表**，是有一个过期时间的。

有了交换机，一般来说，你接个几十台、上百台机器打游戏，应该没啥问题。

---

**小结**

第一，MAC 层是用来解决多路访问的堵车问题的；

第二，ARP 是通过吼的方式来寻找目标 MAC 地址的，吼完之后记住一段时间，这个叫作缓存；

第三，交换机是有 MAC 地址学习能力的，学完了它就知道谁在哪儿了，不用广播了。