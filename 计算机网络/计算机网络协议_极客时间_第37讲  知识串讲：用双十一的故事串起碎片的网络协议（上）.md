# 第37讲 | 知识串讲：用双十一的故事串起碎片的网络协议（上）

### 这个过程分为十个阶段

- 从云平台中搭建一个电商开始

- 到 BGP 路由广播

- 再到 DNS 域名解析

- 从客户看商品图片

- 到最终下单的整个过程

  ### 这节我们先来看前三个阶段。

----

### 1. 部署一个高可用高并发的电商平台

首先，咱们要有个电商平台。假设我们已经有了一个特别大的电商平台，这个平台应该部署在哪里呢？假设我们用**公有云**，一般公有云会有多个位置，比如在华东、华北、华南都有。

>  毕竟咱们的电商是要服务全国的，当然到处都要部署了。我们把**主站点放在华东**。

![img](https://static001.geekbang.org/resource/image/ed/20/eddde5929de2a72b197321e5ad87e120.jpg)

回想数据中心那一节，每个可用区里有一片一片的机柜，每个机柜上有一排一排的服务器，每个机柜都有一个接入交换机，有一个汇聚交换机将多个机柜连在一起。

这些服务器里面部署的都是计算节点，每台上面都有 Open vSwitch 创建的虚拟交换机，将来在这台机器上创建的虚拟机，都会连到 Open vSwitch 上。

![img](https://static001.geekbang.org/resource/image/d6/a7/d66c01c39e911e784525a118c37b50a7.jpg)

接下来，你在云计算的界面上创建一个 VPC（Virtual Private Cloud，虚拟私有网络），**指定一个 IP 段，**这样以后你部署的所有应用都会在这个虚拟网络里，使用你分配的这个 IP 段。

为了**不同的 VPC 相互隔离**，每个 VPC 都会被**分配一个 VXLAN 的 ID**。尽管不同用户的虚拟机有可能在同一个物理机上，但是不同的 VPC 二层压根儿是不通的。

接下来，应该**创建数据库持久化层**。大部分云平台都会提供 PaaS 服务，也就是说，不需要你自己搭建数据库，而是采用直接提供数据库的服务

云平台会给每个 Subnet 的数据库实例**分配一个域名**。创建数据库实例的时候，需要你指定**可用区和 Subnet**，这样创建出来的数据库实例可以通过这个 Subnet 的私网 IP 进行访问。

为了分库分表实现高并发的读写，在创建的多个数据库实例之上，会创建一个**分布式数据库的实例**，也需要指定可用区和 Subnet，还会为分布式数据库分配一个私网 IP 和域名。

接下来是**创建缓存集群**。云平台也会**提供 PaaS 服务**，也需要每个可用区和 Subnet 创建一套，缓存的数据在内存中，由于读写性能要求高，一般不要求跨可用区读写。

再往上层就是**部署咱们自己写的程序**了——基础服务层、组合服务层、Controller 层，以及 Nginx 层、API 网关等等，这些都是部署在虚拟机里面的。它们之间通过 RPC 相互调用，需要到注册中心进行注册。

> 它们之间的网络通信是虚拟机和虚拟机之间的。如果是同一台物理机，则那台物理机上的 OVS 就能转发过去；如果是不同的物理机，这台物理机的 OVS 和另一台物理机的 OVS 中间有一个 VXLAN 的隧道，将请求转发过去。

再往外就是负载均衡了，负载均衡也是云平台提供的 PaaS 服务，也是属于某个 VPC 的，部署在虚拟机里面的，但是负载均衡有个外网的 IP，这个外网的 IP 地址就是在网关节点的外网网口上的。在网关节点上，会有 NAT 规则。

不同的可用区之间，通过核心交换机连在一起，核心交换机之外是边界路由器。

对于一些静态资源，可以保持在对象存储里面，通过 CDN 下发到边缘节点，这样客户端就能尽快加载出来。

---

### 2. 大声告诉全世界，可以到我这里买东西

当电商应用搭建完毕之后，接下来需要将如何访问到这个电商网站广播给全网。

对于多个可用区的情况，我们可以隐去计算节点的情况，**将外网访问区域放大**。

![img](https://static001.geekbang.org/resource/image/e1/24/e132bc3ba500b1197139f30c02e20124.jpg)

外网 IP 是放在虚拟网关的外网网口上的，这个 IP 如何让全世界知道呢？当然是通过 BGP 路由协议了。

在核心交换外面是安全设备，然后就是边界路由器。边界路由器会和多个运营商连接，从而每个运营商都能够访问到这个网站。边界路由器可以通过 BGP 协议，将自己数据中心里面的外网 IP 向外广播，也就是告诉全世界，如果要访问这些外网 IP，都来我这里。每个运营商也有很多的路由器、很多的点，于是就可以将如何到达这些 IP 地址的路由信息，广播到全国乃至全世界。

---

### 3. 打开手机来上网，域名解析得地址

这个时候，不但你的这个网站的 IP 地址全世界都知道了，**你打的广告**可能大家也都看到了，于是有客户下载 App 来买东西了。

![img](https://static001.geekbang.org/resource/image/85/fc/85c125c225faba29c0f374e18ea8c6fc.jpg)

当在手机上面打开一个 App 的时候，首先要做的事情就是**解析这个网站的域名**。

在手机运营商所在的互联网区域里，有一个本地的 DNS，手机会向这个 DNS 请求解析 DNS。当这个 DNS 本地有缓存，则直接返回；如果没有缓存，本地 DNS 才需要递归地从根 DNS 服务器，查到.com 的顶级域名服务器，最终查到权威 DNS 服务器。



如果你使用云平台的时候，配置了智能 DNS 和全局负载均衡。

在权威 DNS 服务中，一般是通过配置 CNAME 的方式，我们可以起一个别名，例如 vip.yourcomany.com ，然后告诉本地 DNS 服务器，让它**请求 GSLB 解析这个域名**，GSLB 就可以在解析这个域名的过程中，通过自己的策略实现负载均衡。



GSLB 通过查看请求它的本地 DNS 服务器所在的运营商和地址，就知道用户所在的运营商和地址，然后将距离用户位置比较近的 Region 里面，三个负载均衡 SLB 的公网 IP 地址，返回给本地 DNS 服务器。本地 DNS 解析器将结果缓存后，返回给客户端。

---

对于手机 App 来说，可以绕过刚才的传统 DNS 解析机制，直接只要 HTTPDNS 服务，通过直接调用 HTTPDNS 服务器，得到这三个 SLB 的公网 IP 地址。

看，经过了如此复杂的过程，咱们的万里长征还没迈出第一步，**刚刚得到 IP 地址，包还没发呢？**话说手机 App 拿到了公网 IP 地址，接下来应该做什么呢？

