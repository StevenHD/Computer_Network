# 第8讲 | 世界这么大，我想出网关：欧洲十国游与玄奘西行

宿舍里和办公室里用到的网络协议。

是时候去外网逛逛了！

宿舍的时候买了台交换机，组了一个局域网打游戏。只能打局域网的游戏，不能上网啊！

要在宿舍上网，有两个办法：

- 再买一个网卡。
- 买个家庭路由器

这两种方法其实是一样的。只不过第一种方式，让你的宿舍长的电脑，变成一个有多个口的路由器而已。

配置你们的网卡。

当然 DHCP 是可以默认配置的。在进行网卡配置的时候，除了 IP 地址，还需要配置一个Gateway 的东西，这个就是网关。

---

一旦配置了 IP 地址和网关，往往就能够指定目标地址进行访问了。

在跨网关访问的时候，牵扯到 MAC 地址和 IP 地址的变化。

详细描述一下 MAC 头和 IP 头的细节。

- 在 MAC 头里面，先是目标 MAC 地址，然后是源 MAC 地址，然后有一个协议类型，用来说明里面是 IP 协议。
- IP 头里面的版本号，目前主流的还是 IPv4，另外，还有 8 位标识协议。这里到了下一层的协议，也就是，是 TCP 还是 UDP。最重要的就是源 IP 和目标 IP。先是源 IP 地址，然后是目标 IP 地址。



在任何一台机器上，当要访问另一个 IP 地址的时候，都会先判断，这个目标 IP 地址，和当前机器的 IP 地址，是否在同一个网段。

怎么判断同一个网段呢？需要 CIDR 和子网掩码。

---

- 如果是同一个网段，例如，你访问你旁边的兄弟的电脑，那就没**网关**什么事情，直接将**源地址和目标地址放入 IP 头**中。通过 **ARP 获得 MAC 地址**，将**源 MAC 和目的 MAC 放入 MAC 头**中，发出去就可以了。

- 如果不是同一网段，这就需要**发往默认网关 Gateway**。Gateway 的地址一定是和源 IP 地址是一个网段的。往往不是第一个，就是第二个。例如 192.168.1.0/24 这个网段，Gateway 往往会是 192.168.1.1/24 或者 192.168.1.2/24。

如何发往默认网关呢？将源地址和目标 IP 地址放入 IP 头中，通过 ARP 获得网关的 MAC 地址，将源 MAC 和网关的 MAC 放入 MAC 头中，发送出去。网关所在的端口，例如 192.168.1.1/24 将网络包收进来

---

**网关往往是一个路由器，是一个三层转发的设备。**

>  啥叫三层设备？前面也说过了，就是把 MAC 头和 IP 头都取下来，然后根据里面的内容，看看接下来把包往哪里转发的设备。

> 在你的宿舍里面，网关就是你宿舍长的电脑。一个路由器往往有多个网口，如果是一台服务器做这个事情，则就有多个网卡，其中一个网卡是和源 IP 同网段的。

任何一个想发往其他局域网的包，都会到达其中一只手，被拿进来，**拿下 MAC 头和 IP 头**，根据自己的路由算法，**选择另一只手，加上 IP 头和 MAC 头**，然后扔出去。

---

#### 静态路由是什么？

静态路由，其实就是在路由器上，配置一条一条规则。

#### IP 头和 MAC 头哪些变、哪些不变？

对于 IP 头和 MAC 头哪些变、哪些不变的问题，可以分两种类型。我把它们称为**“欧洲十国游”型**和**“玄奘西行”型**。

MAC 地址是一个局域网内才有效的地址。因而，MAC 地址只要过网关，就必定会改变，因为已经换了局域网。

**“欧洲十国游”型**和**“玄奘西行”型**。两者主要的区别在于 IP 地址是否改变。不改变 IP 地址的网关，我们称为转发网关；改变 IP 地址的网关，我们称为NAT 网关。

**“欧洲十国游”型** ——发现 MAC 一致，将包收进来，开始思考往哪里转发。每到一个新的局域网，MAC 都是要变的，但是 IP 地址都不变。在 IP 头里面，不会保存任何网关的 IP 地址。**所谓的下一跳是，某个 IP 要将这个 IP 地址转换为 MAC 放入 MAC 头。**

之所以将这种模式比喻称为**欧洲十国游**，是因为在整个过程中，**IP 头里面的地址都是不变的**。

**IP 头不改变。这就像在欧洲各国之间旅游，一个签证就能搞定**。

**“玄奘西行”型**——局域网之间没有商量过，各定各的网段，因而 IP 段冲突了。

从这个过程可以看出，IP 地址也会变。这个过程用英文说就是 **Network Address Translation**，简称 **NAT**。

第二种方式我们经常见，现在大家每家都有家用路由器，家里的网段都是 192.168.1.x，所以你肯定访问不了你邻居家的这个私网的 IP 地址的。

所以，当我们家里的包发出去的时候，都被家用路由器 NAT 成为了运营商的地址了。

很多办公室访问外网的时候，也是被 NAT 过的，因为不可能办公室里面的 IP 也是公网可见的。

---

#### 小结

- 如果离开本局域网，就需要经过网关，网关是路由器的一个网口；
- 路由器是一个三层设备，里面有如何寻找下一跳的规则；
- 经过路由器之后 MAC 头要变，如果 IP 不变，相当于不换护照的欧洲旅游，如果 IP 变，相当于换护照的玄奘西行。