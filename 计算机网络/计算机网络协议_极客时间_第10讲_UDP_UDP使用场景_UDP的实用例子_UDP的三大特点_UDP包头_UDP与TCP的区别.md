# 第10讲 | UDP协议：因性善而简单，难免碰到“城会玩”

讲完了 IP 层以后，接下来开始讲传输层。

传输层里比较重要的两个协议，一个是 TCP，一个是 UDP。

什么叫面向连接，什么叫无连接呢？在互通之前，面向连接的协议会先建立连接。例如，TCP 会三次握手，而 UDP 不会。

**所谓的建立连接，是为了在客户端和服务端维护连接，而建立一定的数据结构来维护双方交互的状态，用这样的数据结构来保证所谓的面向连接的特性。**

例如，TCP 提供可靠交付。

我们都知道 IP 包是没有任何可靠性保证的，一旦发出去，走丢了、都只能随它去。

**UDP 继承了 IP 包的特性，不保证不丢失，不保证按顺序到达。**

**TCP 是面向字节流的**。发送的时候发的是一个流，没头没尾。

IP 包**可不是一个流**，而是一个个的 IP 包。之所以变成了流，这也是 **TCP 自己的状态维护**做的事情。

**UDP 继承了 IP 的特性，基于数据报的，一个一个地发，一个一个地收。**

---

 **TCP 是有拥塞控制的**。它意识到包丢弃了或者网络的环境不好了，就会根据情况调整自己的行为，看看是不是发快了，要不要发慢点。

**UDP 就不会，应用让我发，我就发**，管它呢。

 TCP 其实是一个**有状态服务**，通俗地讲就是有脑子的。

UDP 则是**无状态服务**，通俗地说是没脑子的。

---

>  如果 MAC 层定义了本地局域网的传输行为，IP 层定义了整个网络端到端的传输行为，这两层基本定义了这样的基因：网络传输是以包为单位的，二层叫帧，网络层叫包，传输层叫段。我们笼统地称为包。包单独传输，自行选路，在不同的设备封装解封装，不保证到达。

---

#### UDP 包头是什么样的？

当我发送的 UDP 包到达目标机器后，发现 MAC 地址匹配，于是就取下来，将剩下的包传给处理 IP 层的代码。把 IP 头取下来，发现目标 IP 匹配，接下来呢？

我发的是一个 UDP 的包，收到的那台机器咋知道的呢？所以在 IP 头里面有个 8 位协议，这里会存放，数据里面到底是 TCP 还是 UDP。

如果我们知道 UDP 头的格式，就能从数据里面，将它解析出来。

无论应用程序写的使用 TCP 传数据，还是 UDP 传数据，都要监听一个端口。正是这个端口，用来区分应用程序。

无论是 TCP 还是 UDP 包头里面应该有端口号，根据端口号，将数据交给相应的应用程序。

**端口不能冲突**。

当我们看到 UDP 包头的时候，发现的确有端口号，有源端口号和目标端口号。因为是两端通信。

**UDP 除了端口号，再没有其他的了**。

---

#### UDP 的三大特点

- 不需要大量的数据结构、处理逻辑、包头字段，相信网络通路默认就是很容易送达的，不容易被丢弃的。
- 不会建立连接，虽然有端口号，但是监听在这个地方，谁都可以传给他数据，他也可以传给任何人数据，甚至可以同时传给多个人数据。
- 不会根据网络的情况进行发包的拥塞控制，无论网络丢包丢成啥样了，它该怎么发还怎么发。

---

#### UDP 的三大使用场景

- 需要资源少，在网络情况比较好的内网，或者对于丢包不敏感的应用。
- 不需要一对一沟通，建立连接，而是可以广播的应用。
- 需要处理速度快，时延低，可以容忍少数丢包，但是要求即便网络拥塞，也毫不退缩，一往无前的时候。

---

#### 基于 UDP 的“城会玩”的五个例子

- **网页或者 APP 的访问**，原来访问网页和手机 APP 都是基于 HTTP 协议的。HTTP 协议是基于 TCP 的，建立连接都需要多次交互。目前的 HTTP 协议，往往采取多个数据通道共享一个连接的情况，这样本来为了加快传输速度，但是 TCP 的严格顺序策略使得哪怕共享通道，前一个不来，后一个和前一个即便没关系，也要等着，时延也会加大。

  >  而 QUIC（全称 Quick UDP Internet Connections，快速 UDP 互联网连接）是 Google 提出的一种基于 UDP 改进的通信协议，其目的是降低网络通信的延迟，提供更好的用户互动体验。

**QUIC 在应用层上，会自己实现快速连接建立、减少重传时延，自适应拥塞控制**，是应用层“城会玩”的代表。

- **流媒体的协议**，直播协议多使用 RTMP，而这个 RTMP 协议也是基于 TCP 的。TCP 的严格顺序传输要保证前一个收到了，下一个才能确认，如果前一个收不到，下一个就算包已经收到了，在缓存里面，也需要等着。

  > 当网络不好的时候，TCP 协议会主动降低发送速度，这对本来当时就卡的看视频来讲是要命的，应该应用层马上重传，而不是主动让步。因而，很多直播应用，都基于 UDP 实现了自己的视频传输协议。

- **实时游戏**，实时游戏中客户端和服务端要建立长连接，来保证实时传输。但是游戏玩家很多，服务器却不多。由于维护 TCP 连接需要在内核维护一些数据结构，因而一台机器能够支撑的 TCP 连接数目是有限的，然后 UDP 由于是没有连接的，在异步 IO 机制引入之前，常常是应对海量客户端连接的策略。

  **TCP 的强顺序问题**，如果出现一个数据包丢失，所有事情都需要停下来等待这个数据包重发。客户端会出现等待接收数据，然而玩家并不关心过期的数据，激战中卡 1 秒，等能动了都已经死了。

  > 游戏对实时要求较为严格的情况下，采用自定义的可靠 UDP 协议，自定义重传策略，能够把丢包产生的延迟降到最低，尽量减少网络问题对游戏性造成的影响。

- **IoT 物联网**，Google 旗下的 Nest 建立 Thread Group，推出了物联网通信协议 Thread，就是基于 UDP 协议的。

- **移动通信领域**，在 4G 网络里，移动流量上网的数据面对的协议 GTP-U 是基于 UDP 的。

---

**小结**

- TCP 复杂，UDP 简单；TCP 维护连接，UDP 谁都相信；TCP 会坚持知进退；UDP 愣头青一个，勇往直前；

- UDP 虽然简单，但它有简单的用法。它可以用在环境简单、需要多播、应用层自己控制传输的地方。例如 DHCP、VXLAN、QUIC 等。