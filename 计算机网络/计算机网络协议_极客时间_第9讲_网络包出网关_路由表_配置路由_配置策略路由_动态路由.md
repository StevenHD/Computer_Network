# 第9讲 | 路由协议：西出网关无故人，敢问路在何方

网络包一旦出了网关，就像玄奘西行一样踏上了江湖漂泊的路。

### 如何配置路由？

路由器就是一台网络设备，它有多张网卡。当一个入口的网络包送到路由器时，它会根据一个本地的转发信息库，来决定如何正确地转发流量。这个转发信息库通常被称为**路由表**。

一张路由表中会有多条路由规则：

- 目的网络：这个包想去哪儿？
- 出口设备：将包从哪个口扔出去？
- 下一跳网关：下一个路由器的地址。

**网关上的路由策略**就是按照这**三项配置**信息进行配置的。这种配置方式的一个核心思想是：**根据目的 IP 地址来配置路由**。

---

### 如何配置策略路由？

在真实的复杂的网络环境中，除了可以**根据目的 ip 地址配置路由**外，还可以**根据多个参数来配置路由**，这就称为**策略路由**。

可以配置多个路由表，可以根据源 IP 地址、入口设备、TOS 等选择路由表，然后在路由表中查找路由。这样可以使得来自不同来源的包走不同的路由。

家里的网络，就是普通的家用网段 192.168.1.x/24。家里有两个租户，分别把线连到路由器上。IP 地址为 192.168.1.101/24 和 192.168.1.102/24，网关都是 192.168.1.1/24，**网关在路由器上**。

家里的网段是私有网段，出去的包需要 NAT 成公网的 IP 地址，因而路由器是一个 NAT 路由器。

>  静态的路由，一般来说网络环境简单的时候，在自己的可控范围之内，自己捣鼓还是可以的。但是有时候网络环境复杂并且多变，如果总是用静态路由，一旦网络结构发生变化，让网络管理员手工修改路由太复杂了，因而需要动态路由算法。

---

### 动态路由算法

使用动态路由路由器，可以根据路由协议算法生成动态路由表，随网络运行状况的变化而变化。

转化成为如何**在途中找到最短路径**的问题。

#### 1. 距离矢量路由算法

基于 Bellman-Ford 算法的。

第一个问题就是好消息传得快，坏消息传得慢。

这种算法的第二个问题是，每次发送的时候，要发送整个全局路由表。

#### 2. 链路状态路由算法

第二大类算法是链路状态路由（link state routing），基于 Dijkstra 算法。

---

#### 动态路由协议

1. 基于链路状态路由算法的 OSPFOSPF（Open Shortest Path First，开放式最短路径优先）就是这样一个基于链路状态路由协议，广泛应用在数据中心中的协议。由于主要用在数据中心内部，用于路由决策，因而称为内部网关协议（Interior Gateway Protocol，简称 IGP）。

   > 当然有时候 OSPF 可以发现多个最短的路径，可以在这多个路径中进行负载均衡，这常常被称为等价路由。

2. 基于距离矢量路由算法的 BGP

   > 但是外网的路由协议，也即国家之间的，又有所不同。我们称为外网路由协议（Border Gateway Protocol，简称 BGP）。

在网络世界，这一个个国家成为自治系统 **AS**（Autonomous System）。自治系统分几种类型。

BGP 又分为两类，eBGP 和 iBGP。

BGP 协议使用的算法是路径矢量路由协议（path-vector protocol）。它是距离矢量路由协议的升级版。

---

- 路由分静态路由和动态路由，静态路由可以配置复杂的策略路由，控制转发策略；
- 动态路由主流算法有两种，距离矢量算法和链路状态算法。基于两种算法产生两种协议，BGP 协议和 OSPF 协议。